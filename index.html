<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>[ALPHA] Virtual TTC Academy TOD</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <script>
        let selection = null;
    </script>
    <div class="full" id="full">
        <h1>Virtual TTC Academy TOD</h1><br>
        <div id="status">
            <h6>Connection Status: Connecting...</h6>
        </div>
        <h3>Select Service:</h3>
        <input type="radio" id="DM" name="dest" onclick="selection = 'Don Mills';">
        <label for="DM">Sheppard-Yonge -> Don Mills</label><br>
        <input type="radio" id="SHY" name="dest" onclick="selection = 'Sheppard-Yonge'">
        <label for="SHY">Don Mills -> Sheppard-Yonge</label>
        <h3>Login:</h3>
        <div id="progress" class=""></div>
        <input type="text" id="badge" placeholder="Badge #">
        <input type="password" id="pass" placeholder="Password">
        <input type="button" id="login" value="Login" onclick="sendLogin()" disabled><br>
        <a href="tod">Click here if you've already logged in with this machine.</a>
        <p>Quick Explanation: Once you log in, you will be redirected to the TOD,<br>
        You can resize the window to however you like.<br>
        The signals you see are the signals <b>BEFORE</b> and <b>AFTER</b> the stations.<br>
        If you see a Red Signal and you are not at a station, do <b>NOT</b> arrive or cross the signal before a crossing.<br></p>
        <p>Please give feedback if you have any.<br></p>
        <small>Disclaimer: Passwords are not encrypted and are generated by the creator (gtaEPIC)</small><br>
        <small>Disclaimer: The TOD System is still in ALPHA, if you encounter any bugs please let me know. Thanks</small>
    </div>
    <script>
        const domain = "54.224.79.132";
        const ws = new WebSocket("wss://" + domain + ":8080");
        let loggingIn = false;

        function setCookie(name, value, minutes) {
            let d = new Date();
            d.setTime(d.getTime() + (minutes*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        ws.addEventListener("open", ev => {
            document.getElementById("status").innerHTML = "<h6>Connection Status: CONNECTED</h6>";
            document.getElementById("login").attributes.removeNamedItem("disabled");
        });

        ws.addEventListener("error", ev => {
            document.getElementById("status").innerHTML = "<h5>Connection Status: FAILED (Refreshing in 10s)</h5>" +
                "<meta http-equiv='refresh' content='10' />";
        });

        ws.addEventListener("close", ev => {
           document.getElementById("status").innerHTML = "<h5>Connection Status: CLOSED (Refreshing in 10s)</h5>" +
               "<meta http-equiv='refresh' content='10' />";
           if (loggingIn) {
               document.getElementById("progress").setAttribute("class", "failed");
               document.getElementById("progress").innerHTML = "Server closed";
           }
        });

        ws.addEventListener("message", ev => {
            let content = ev.data;
            let data = JSON.parse(content);

            if (data.success) {
                document.getElementById("progress").setAttribute("class", "processing");
                document.getElementById("progress").innerHTML = "Logged in! Preparing...";
                setCookie("run", data.msg, 60);

                document.getElementById("progress").setAttribute("class", "success");
                document.getElementById("progress").innerHTML = "Logged in! Redirecting..." +
                    "<meta http-equiv='refresh' content='2; url=tod' />";
            }else{
                document.getElementById("progress").setAttribute("class", "failed");
                document.getElementById("progress").innerHTML = "Failed to login: " + data.msg;
            }
        });

        function sendLogin() {
            if (selection === null) {
                document.getElementById("progress").setAttribute("class", "failed");
                document.getElementById("progress").innerHTML = "Please select a service and try again";
            }else{
                document.getElementById("progress").setAttribute("class", "sent");
                document.getElementById("progress").innerHTML = "Logging In..."
                let badge = document.getElementById("badge").value;
                let pass = document.getElementById("pass").value;

                if (badge === "" || pass === "") {
                    document.getElementById("progress").setAttribute("class", "failed");
                    document.getElementById("progress").innerHTML = "Please make sure Badge and Passwords are entered.";
                    return;
                }

                setCookie("badge", badge, 60);

                let message = {};
                message.type = "login";
                message.badge = badge;
                message.pass = pass;
                message.dest = selection;
                loggingIn = true;
                ws.send(JSON.stringify(message));
            }
        }
    </script>
</body>
</html>